<head>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
</head>

<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="ggy的个人博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://ggyggy666.github.io">
    <!--SEO-->

<meta name="keywords" content="区块链安全之EOS学习（三）" />


<meta name="description" content="上一篇讲到了对合约创建表，修改和删除表中记录。本次则显示如何持久存储合约使用的数据以及创建许多索引来访问该数据。


二级索引EOSIO能按最多16个索引来对表进行排序。
删除表中现有数据12c..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    区块链安全之EOS学习（三） |
    
    ggy的个人博客
</title>

<link rel="alternate" href="/atom.xml" title="ggy的个人博客" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 4.2.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    https://pic.downk.cc/item/5e3816b82fb38b8c3c8791f9.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='ggy'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <h2>
                欢迎来到ggy的个人网站
            </h2>
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://ggyggy666.github.io">
                        ggy的个人博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/web安全/"><i class="fa "></i>
                                web安全</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/python工具/"><i class="fa "></i>
                                python工具</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/密码学/"><i class="fa "></i>
                                密码学</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="区块链安全之EOS学习（三）">
            
            区块链安全之EOS学习（三）
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/BlockChain/">BlockChain</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8%E4%B9%8BEOS%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%89%EF%BC%89/" rel="tag">区块链安全之EOS学习（三）</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2021/03/18</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p>上一篇讲到了对合约创建表，修改和删除表中记录。本次则显示如何持久存储合约使用的数据以及创建许多索引来访问该数据。</p>
<a id="more"></a>

<h1 id="二级索引"><a href="#二级索引" class="headerlink" title="二级索引"></a>二级索引</h1><p>EOSIO能按最多16个索引来对表进行排序。</p>
<h2 id="删除表中现有数据"><a href="#删除表中现有数据" class="headerlink" title="删除表中现有数据"></a>删除表中现有数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook erase &#39;[&quot;alice&quot;]&#39; -p alice@active</span><br><span class="line">cleos push action addressbook erase &#39;[&quot;bob&quot;]&#39; -p bob@active</span><br></pre></td></tr></table></figure>

<p>删除之前添加的alice和bob的记录。</p>
<h2 id="添加新的索引成员及其获取器"><a href="#添加新的索引成员及其获取器" class="headerlink" title="添加新的索引成员及其获取器"></a>添加新的索引成员及其获取器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint64_t age;</span><br><span class="line">uint64_t get_secondary_1() const &#123;return age;&#125;</span><br></pre></td></tr></table></figure>

<p>之前是用key作为唯一主键，现在使用一个age（数字字段）作为二级索引，然后使用get_secondary_1函数来返回这个age。</p>
<h2 id="添加辅助索引到addresses表配置"><a href="#添加辅助索引到addresses表配置" class="headerlink" title="添加辅助索引到addresses表配置"></a>添加辅助索引到addresses表配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">using address_index &#x3D; eosio::multi_index&lt;&quot;people&quot;_n, person, indexed_by&lt;&quot;byage&quot;_n,const_mem_fun&lt;person, uint64_t, &amp;person::get_secondary_1&gt;&gt;&gt;;</span><br></pre></td></tr></table></figure>

<p>在第三个结构中，传递了一个indexed_by用于实例化索引的结构。index名称是byage, 第二个类型参数是函数调用运算符，该函数将const值提取为索引键。将其指向我们先前创建的get_secondary_1，以便此多索引表将按age变量对记录进行索引。</p>
<h2 id="修改upsert程序"><a href="#修改upsert程序" class="headerlink" title="修改upsert程序"></a>修改upsert程序</h2><p>upsert参数值增加一个age, 之后初始化的时候也增加一个row.age = age即可。</p>
<h2 id="编译-部署"><a href="#编译-部署" class="headerlink" title="编译/部署"></a>编译/部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eosio-cpp --abigen addressbook.cpp -o addressbook.wasm	&#x2F;&#x2F;编译</span><br><span class="line">cleos set contract addressbook &#x2F;home&#x2F;ggy&#x2F;桌面&#x2F;blockchain&#x2F;contracts&#x2F;addressbook	&#x2F;&#x2F;部署</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>插入alice和bob的记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook upsert &#39;[&quot;alice&quot;, &quot;alice&quot;, &quot;liddell&quot;, 9, &quot;123 drink me way&quot;, &quot;wonderland&quot;, &quot;amsterdam&quot;]&#39; -p alice@active</span><br><span class="line"></span><br><span class="line">cleos push action addressbook upsert &#39;[&quot;bob&quot;, &quot;bob&quot;, &quot;is a guy&quot;, 49, &quot;doesnt exist&quot;, &quot;somewhere&quot;, &quot;someplace&quot;]&#39; -p bob@active</span><br></pre></td></tr></table></figure>

<p>通过年龄age索引来查找alice的地址，–index 2参数用于表示使用二级索引查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cleos get table addressbook addressbook people --upper 10 \</span><br><span class="line">--key-type i64 \</span><br><span class="line">--index 2</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;按bob的年龄</span><br><span class="line">cleos get table addressbook addressbook people --upper 50 --key-type i64 --index 2</span><br></pre></td></tr></table></figure>

<h2 id="最终完整合约"><a href="#最终完整合约" class="headerlink" title="最终完整合约"></a>最终完整合约</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/eosio.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/print.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">"addressbook"</span>)]] addressbook : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  addressbook(name receiver, name code,  datastream&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; ds): contract(receiver, code, ds) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">upsert</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> first_name, <span class="built_in">std</span>::<span class="built_in">string</span> last_name, <span class="keyword">uint64_t</span> age, <span class="built_in">std</span>::<span class="built_in">string</span> street, <span class="built_in">std</span>::<span class="built_in">string</span> city, <span class="built_in">std</span>::<span class="built_in">string</span> state)</span> </span>&#123;</span><br><span class="line">    require_auth( user );</span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(),get_first_receiver().value)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    <span class="keyword">if</span>( iterator == addresses.end() )</span><br><span class="line">    &#123;</span><br><span class="line">      addresses.emplace(user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">       row.key = user;</span><br><span class="line">       row.first_name = first_name;</span><br><span class="line">       row.last_name = last_name;</span><br><span class="line">       row.age = age;</span><br><span class="line">       row.street = street;</span><br><span class="line">       row.city = city;</span><br><span class="line">       row.state = state;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      addresses.modify(iterator, user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">        row.key = user;</span><br><span class="line">        row.first_name = first_name;</span><br><span class="line">        row.last_name = last_name;</span><br><span class="line">        row.age = age;</span><br><span class="line">        row.street = street;</span><br><span class="line">        row.city = city;</span><br><span class="line">        row.state = state;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(name user)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line"></span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_self(), get_first_receiver().value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    check(iterator != addresses.end(), <span class="string">"Record does not exist"</span>);</span><br><span class="line">    addresses.erase(iterator);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> [[<span class="title">eosio</span>:</span>:table]] person &#123;</span><br><span class="line">    name key;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> first_name;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> last_name;</span><br><span class="line">    <span class="keyword">uint64_t</span> age;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> street;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> city;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> primary_key() <span class="keyword">const</span> &#123; <span class="keyword">return</span> key.value; &#125;</span><br><span class="line">    <span class="keyword">uint64_t</span> get_secondary_1() <span class="keyword">const</span> &#123; <span class="keyword">return</span> age; &#125;</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">using</span> address_index = eosio::multi_index&lt;<span class="string">"people"</span>_n, person, indexed_by&lt;<span class="string">"byage"</span>_n, const_mem_fun&lt;person, <span class="keyword">uint64_t</span>, &amp;person::get_secondary_1&gt;&gt;&gt;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="添加内联操作"><a href="#添加内联操作" class="headerlink" title="添加内联操作"></a>添加内联操作</h1><p>从合约调用内联操作。首先得构造出这些action，然后从合约中发送这些action。其实就是<strong>在执行一些操作后，发送一些通知消息，比如成功修改记录这些.</strong></p>
<h2 id="将eosio-code添加到权限"><a href="#将eosio-code添加到权限" class="headerlink" title="将eosio.code添加到权限"></a>将eosio.code添加到权限</h2><p>将eosio.code权限添加到合同账户的合同权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos set account permission addressbook active --add-code</span><br></pre></td></tr></table></figure>

<p>授权后才能使合同执行内联操作。</p>
<h2 id="通知action"><a href="#通知action" class="headerlink" title="通知action"></a>通知action</h2><p>在之前的addressbook类中创建一个辅助函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[[eosio::action]]</span><br><span class="line">void notify(name user, std::string msg)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>user表示是通知哪个用户，msg表示发送的消息。</p>
<p>需要将用户添加到require_recipient中，然后要求发送消息是给require_recipient中的用户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require_recipient(user);</span><br></pre></td></tr></table></figure>

<p>然后这样任何用户都可以调用这个Notify函数，因此需要确保是合约自身调用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require_auth(get_self());</span><br></pre></td></tr></table></figure>

<p>如果bob用户传参alice会发生异常。</p>
<h2 id="action构造器"><a href="#action构造器" class="headerlink" title="action构造器"></a>action构造器</h2><p>内联操作会被多次调用，因此最好编写快速构造器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private:</span><br><span class="line">	void send_summary(name user, std::string message)&#123;</span><br><span class="line">		action(</span><br><span class="line">			permission_level&#123;get_self(), &quot;active&quot;_n&#125;,</span><br><span class="line">            get_self(),</span><br><span class="line">            &quot;notify&quot;_n,</span><br><span class="line">            std::make_tuple(user, name&#123;user&#125;.to_string()+message)</span><br><span class="line">		).send();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>该action构造器需要4个参数：</p>
<ul>
<li>permission_level结构：要授权得到许可，应使用active授权机构用来授权get_self()。</li>
<li>调用合约的user：最后就是使用get_self()。</li>
<li>action：使用上面已经创建的notify函数。_n是运算符。</li>
<li>传递的数据：由nofity函数可知，接受两个参数user和message, 而这个action构造器接受byte类型的，因此需要使用make_tuple函数将这两个数据连接起来转成byte类型。</li>
</ul>
<p>最后发送动作：.send();</p>
<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><ul>
<li><p>合约部署后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send_summary(user, &quot;successfully implaced record to addressbook&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>合约的记录修改后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send_summary(user, &quot;successfully modified record in addressbook&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>合约的记录删除后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send_summary(user, &quot;successfully erased record from addressbook&quot;);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="最终完整合约-1"><a href="#最终完整合约-1" class="headerlink" title="最终完整合约"></a>最终完整合约</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/eosio.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/print.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">"addressbook"</span>)]] addressbook : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  addressbook(name receiver, name code,  datastream&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; ds): contract(receiver, code, ds) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">upsert</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> first_name, <span class="built_in">std</span>::<span class="built_in">string</span> last_name, <span class="keyword">uint64_t</span> age, <span class="built_in">std</span>::<span class="built_in">string</span> street, <span class="built_in">std</span>::<span class="built_in">string</span> city, <span class="built_in">std</span>::<span class="built_in">string</span> state)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    <span class="keyword">if</span>( iterator == addresses.end() )</span><br><span class="line">    &#123;</span><br><span class="line">      addresses.emplace(user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">       row.key = user;</span><br><span class="line">       row.first_name = first_name;</span><br><span class="line">       row.last_name = last_name;</span><br><span class="line">       row.age = age;</span><br><span class="line">       row.street = street;</span><br><span class="line">       row.city = city;</span><br><span class="line">       row.state = state;</span><br><span class="line">      &#125;);</span><br><span class="line">      send_summary(user, <span class="string">" successfully emplaced record to addressbook"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      addresses.modify(iterator, user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">        row.key = user;</span><br><span class="line">        row.first_name = first_name;</span><br><span class="line">        row.last_name = last_name;</span><br><span class="line">        row.street = street;</span><br><span class="line">        row.city = city;</span><br><span class="line">        row.state = state;</span><br><span class="line">      &#125;);</span><br><span class="line">      send_summary(user, <span class="string">" successfully modified record to addressbook"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(name user)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line"></span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    check(iterator != addresses.end(), <span class="string">"Record does not exist"</span>);</span><br><span class="line">    addresses.erase(iterator);</span><br><span class="line">    send_summary(user, <span class="string">" successfully erased record from addressbook"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">notify</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> msg)</span> </span>&#123;</span><br><span class="line">    require_auth(get_self());</span><br><span class="line">    require_recipient(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> [[<span class="title">eosio</span>:</span>:table]] person &#123;</span><br><span class="line">    name key;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> first_name;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> last_name;</span><br><span class="line">    <span class="keyword">uint64_t</span> age;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> street;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> city;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> primary_key() <span class="keyword">const</span> &#123; <span class="keyword">return</span> key.value; &#125;</span><br><span class="line">    <span class="keyword">uint64_t</span> get_secondary_1() <span class="keyword">const</span> &#123; <span class="keyword">return</span> age;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">send_summary</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> message)</span> </span>&#123;</span><br><span class="line">    action(</span><br><span class="line">      permission_level&#123;get_self(),<span class="string">"active"</span>_n&#125;,</span><br><span class="line">      get_self(),</span><br><span class="line">      <span class="string">"notify"</span>_n,</span><br><span class="line">      <span class="built_in">std</span>::make_tuple(user, name&#123;user&#125;.to_string() + message)</span><br><span class="line">    ).send();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">typedef</span> eosio::multi_index&lt;<span class="string">"people"</span>_n, person,</span><br><span class="line">    indexed_by&lt;<span class="string">"byage"</span>_n, const_mem_fun&lt;person, <span class="keyword">uint64_t</span>, &amp;person::get_secondary_1&gt;&gt;</span><br><span class="line">  &gt; address_index;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="编译-部署-1"><a href="#编译-部署-1" class="headerlink" title="编译/部署"></a>编译/部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;ggy&#x2F;桌面&#x2F;blockchain&#x2F;contracts&#x2F;addressbook</span><br><span class="line"></span><br><span class="line">eosio-cpp -o addressbook.wasm addressbook.cpp --abigen</span><br><span class="line"></span><br><span class="line">cleos set contract addressbook &#x2F;home&#x2F;ggy&#x2F;桌面&#x2F;blockchain&#x2F;contracts&#x2F;addressbook</span><br></pre></td></tr></table></figure>

<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook upsert &#39;[&quot;alice&quot;, &quot;alice&quot;, &quot;liddell&quot;, 21, &quot;123 drink me way&quot;, &quot;wonderland&quot;, &quot;amsterdam&quot;]&#39; -p alice@active</span><br></pre></td></tr></table></figure>

<p>增加一条alice记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos get actions alice</span><br></pre></td></tr></table></figure>

<p>显示已执行的与alice相关的action。</p>
<h1 id="对外部合约的内联操作"><a href="#对外部合约的内联操作" class="headerlink" title="对外部合约的内联操作"></a>对外部合约的内联操作</h1><p>上面是对合约内部的操作，接下来是对外部合约的操作。</p>
<h2 id="创建外部合约"><a href="#创建外部合约" class="headerlink" title="创建外部合约"></a>创建外部合约</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /home/ggy/桌面/blockchain/contracts</span><br><span class="line">mkdir abcounter</span><br><span class="line">cd abcounter</span><br><span class="line">touch abcounter.cpp</span><br></pre></td></tr></table></figure>

<p>vim打开后，输入以下合约代码保存：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/eosio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">"abcounter"</span>)]] abcounter : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    abcounter(name receiver, name code,  datastream&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; ds): contract(receiver, code, ds) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    [[eosio::action]]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">count</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> type)</span> </span>&#123;</span><br><span class="line">      require_auth( name(<span class="string">"addressbook"</span>));	<span class="comment">//限制只能addressbook合约调用</span></span><br><span class="line">      <span class="function">count_index <span class="title">counts</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line">      <span class="keyword">auto</span> iterator = counts.find(user.value);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (iterator == counts.end()) &#123;</span><br><span class="line">        counts.emplace(<span class="string">"addressbook"</span>_n, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">          row.key = user;</span><br><span class="line">          row.emplaced = (type == <span class="string">"emplace"</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">          row.modified = (type == <span class="string">"modify"</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">          row.erased = (type == <span class="string">"erase"</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        counts.modify(iterator, <span class="string">"addressbook"</span>_n, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">          <span class="keyword">if</span>(type == <span class="string">"emplace"</span>) &#123; row.emplaced += <span class="number">1</span>; &#125;</span><br><span class="line">          <span class="keyword">if</span>(type == <span class="string">"modify"</span>) &#123; row.modified += <span class="number">1</span>; &#125;</span><br><span class="line">          <span class="keyword">if</span>(type == <span class="string">"erase"</span>) &#123; row.erased += <span class="number">1</span>; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//动作包装器，第一个参数是要调用的动作，第二个则是指向动作函数</span></span><br><span class="line">    <span class="keyword">using</span> count_action = action_wrapper&lt;<span class="string">"count"</span>_n, &amp;abcounter::count&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> [[<span class="title">eosio</span>:</span>:table]] counter &#123;</span><br><span class="line">      name key;</span><br><span class="line">      <span class="keyword">uint64_t</span> emplaced;</span><br><span class="line">      <span class="keyword">uint64_t</span> modified;</span><br><span class="line">      <span class="keyword">uint64_t</span> erased;</span><br><span class="line">      <span class="keyword">uint64_t</span> primary_key() <span class="keyword">const</span> &#123; <span class="keyword">return</span> key.value; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> count_index = eosio::multi_index&lt;<span class="string">"counts"</span>_n, counter&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="创建合约账户"><a href="#创建合约账户" class="headerlink" title="创建合约账户"></a>创建合约账户</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos create account eosio abcounter EOS8STYz9TYuEDHS1fErjgaDR1ApTk62eEaBzC7Jhn486paNrgsZC</span><br></pre></td></tr></table></figure>

<p>创建abcounter账户</p>
<h2 id="编译-部署-2"><a href="#编译-部署-2" class="headerlink" title="编译/部署"></a>编译/部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eosio-cpp abcounter.cpp -o abcounter.wasm</span><br><span class="line"></span><br><span class="line">cleos set contract abcounter &#x2F;home&#x2F;ggy&#x2F;桌面&#x2F;blockchain&#x2F;contracts&#x2F;abcounter</span><br></pre></td></tr></table></figure>

<h2 id="修改addressbook合约"><a href="#修改addressbook合约" class="headerlink" title="修改addressbook合约"></a>修改addressbook合约</h2><p>这是为了通过修改addressbook合约来执行对外部合约的调用操作。</p>
<p>在private中创建一个合约声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void increment_counter(name user, std::string type)&#123;</span><br><span class="line">	abcounter::count_action count(&quot;abcounter&quot;_n, &#123;get_self(), &quot;active&quot;_n&#125;);</span><br><span class="line">	count.send(user, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用的是count_action动作包装器，初始化了count_action对象。</p>
<ul>
<li>第一个参数是合同名称abcounter</li>
<li>第二个参数是权限结构：get_self()是当前addressbook合约，使用active许可该合约。</li>
</ul>
<p>不需要额外指定action，因为动作包装前已经在定义action时合并了action。</p>
<p>接下来将increment_counter应用在每一个action。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Emplace</span><br><span class="line">increment_counter(user, &quot;emplace&quot;);</span><br><span class="line">&#x2F;&#x2F;Modify</span><br><span class="line">increment_counter(user, &quot;modify&quot;);</span><br><span class="line">&#x2F;&#x2F;Erase</span><br><span class="line">increment_counter(user, &quot;erase&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="最终合约"><a href="#最终合约" class="headerlink" title="最终合约"></a>最终合约</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/eosio.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"abcounter.cpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">"addressbook"</span>)]] addressbook : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  addressbook(name receiver, name code,  datastream&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; ds): contract(receiver, code, ds) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">upsert</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> first_name, <span class="built_in">std</span>::<span class="built_in">string</span> last_name,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">uint64_t</span> age, <span class="built_in">std</span>::<span class="built_in">string</span> street, <span class="built_in">std</span>::<span class="built_in">string</span> city, <span class="built_in">std</span>::<span class="built_in">string</span> state)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    <span class="keyword">if</span>( iterator == addresses.end() )</span><br><span class="line">    &#123;</span><br><span class="line">      addresses.emplace(user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">       row.key = user;</span><br><span class="line">       row.first_name = first_name;</span><br><span class="line">       row.last_name = last_name;</span><br><span class="line">       row.age = age;</span><br><span class="line">       row.street = street;</span><br><span class="line">       row.city = city;</span><br><span class="line">       row.state = state;</span><br><span class="line">      &#125;);</span><br><span class="line">      send_summary(user, <span class="string">" successfully emplaced record to addressbook"</span>);</span><br><span class="line">      increment_counter(user, <span class="string">"emplace"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> changes;</span><br><span class="line">      addresses.modify(iterator, user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line">        row.key = user;</span><br><span class="line">        row.first_name = first_name;</span><br><span class="line">        row.last_name = last_name;</span><br><span class="line">        row.age = age;</span><br><span class="line">        row.street = street;</span><br><span class="line">        row.city = city;</span><br><span class="line">        row.state = state;</span><br><span class="line">      &#125;);</span><br><span class="line">      send_summary(user, <span class="string">" successfully modified record to addressbook"</span>);</span><br><span class="line">      increment_counter(user, <span class="string">"modify"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(name user)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line"></span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    check(iterator != addresses.end(), <span class="string">"Record does not exist"</span>);</span><br><span class="line">    addresses.erase(iterator);</span><br><span class="line">    send_summary(user, <span class="string">" successfully erased record from addressbook"</span>);</span><br><span class="line">    increment_counter(user, <span class="string">"erase"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">notify</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> msg)</span> </span>&#123;</span><br><span class="line">    require_auth(get_self());</span><br><span class="line">    require_recipient(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> [[<span class="title">eosio</span>:</span>:table]] person &#123;</span><br><span class="line">    name key;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> first_name;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> last_name;</span><br><span class="line">    <span class="keyword">uint64_t</span> age;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> street;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> city;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> primary_key() <span class="keyword">const</span> &#123; <span class="keyword">return</span> key.value; &#125;</span><br><span class="line">    <span class="keyword">uint64_t</span> get_secondary_1() <span class="keyword">const</span> &#123; <span class="keyword">return</span> age;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">send_summary</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> message)</span> </span>&#123;</span><br><span class="line">    action(</span><br><span class="line">      permission_level&#123;get_self(),<span class="string">"active"</span>_n&#125;,</span><br><span class="line">      get_self(),</span><br><span class="line">      <span class="string">"notify"</span>_n,</span><br><span class="line">      <span class="built_in">std</span>::make_tuple(user, name&#123;user&#125;.to_string() + message)</span><br><span class="line">    ).send();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">increment_counter</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> type)</span> </span>&#123;</span><br><span class="line">    abcounter::<span class="function">count_action <span class="title">count</span><span class="params">(<span class="string">"abcounter"</span>_n, &#123;get_self(), <span class="string">"active"</span>_n&#125;)</span></span>;</span><br><span class="line">    count.send(user, type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">typedef</span> eosio::multi_index&lt;<span class="string">"people"</span>_n, person,</span><br><span class="line">    indexed_by&lt;<span class="string">"byage"</span>_n, const_mem_fun&lt;person, <span class="keyword">uint64_t</span>, &amp;person::get_secondary_1&gt;&gt;</span><br><span class="line">  &gt; address_index;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="重新编译-部署"><a href="#重新编译-部署" class="headerlink" title="重新编译/部署"></a>重新编译/部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eosio-cpp -o addressbook.wasm addressbook.cpp -I ..&#x2F;abcounter&#x2F;</span><br><span class="line"></span><br><span class="line">cleos set contract addressbook &#x2F;home&#x2F;ggy&#x2F;桌面&#x2F;blockchain&#x2F;contracts&#x2F;addressbook</span><br></pre></td></tr></table></figure>

<h2 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook upsert '["alice", "alice", "liddell", 19, "123 drink me way", "wonderland", "amsterdam"]' -p alice@active</span><br></pre></td></tr></table></figure>

<p>可以看到计数器已经成功通知。接着检查表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos get table abcounter abcounter counts --lower alice --limit 1</span><br></pre></td></tr></table></figure>

<p>测试每个action并检查计数器。</p>
<p>upsert修改记录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook upsert '["alice", "alice", "liddell", 21,"1 there we go", "wonderland", "amsterdam"]' -p alice@active</span><br></pre></td></tr></table></figure>

<p>erase删除记录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook erase '["alice"]' -p alice@active</span><br></pre></td></tr></table></figure>

<p>直接调用abcounter合约来操纵数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action abcounter count '["alice", "erase"]' -p alice@active</span><br></pre></td></tr></table></figure>

<h2 id="增加更多信息"><a href="#增加更多信息" class="headerlink" title="增加更多信息"></a>增加更多信息</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/eosio.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"abcounter.cpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">"addressbook"</span>)]] addressbook : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  addressbook(name receiver, name code,  datastream&lt;<span class="keyword">const</span> <span class="keyword">char</span>*&gt; ds): contract(receiver, code, ds) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">upsert</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> first_name, <span class="built_in">std</span>::<span class="built_in">string</span> last_name, <span class="keyword">uint64_t</span> age, <span class="built_in">std</span>::<span class="built_in">string</span> street, <span class="built_in">std</span>::<span class="built_in">string</span> city, <span class="built_in">std</span>::<span class="built_in">string</span> state)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line"></span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    <span class="keyword">if</span>( iterator == addresses.end() )</span><br><span class="line">    &#123;</span><br><span class="line">      addresses.emplace(user, [&amp;]( <span class="keyword">auto</span>&amp; row )&#123;</span><br><span class="line">       row.key = user;</span><br><span class="line">       row.first_name = first_name;</span><br><span class="line">       row.last_name = last_name;</span><br><span class="line">       row.age = age;</span><br><span class="line">       row.street = street;</span><br><span class="line">       row.city = city;</span><br><span class="line">       row.state = state;</span><br><span class="line">       send_summary(user, <span class="string">" successfully emplaced record to addressbook"</span>);</span><br><span class="line">       increment_counter(user, <span class="string">"emplace"</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> changes;</span><br><span class="line">      addresses.modify(iterator, user, [&amp;]( <span class="keyword">auto</span>&amp; row ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row.first_name != first_name) &#123;</span><br><span class="line">          row.first_name = first_name;</span><br><span class="line">          changes += <span class="string">"first name "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row.last_name != last_name) &#123;</span><br><span class="line">          row.last_name = last_name;</span><br><span class="line">          changes += <span class="string">"last name "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row.age != age) &#123;</span><br><span class="line">          row.age = age;</span><br><span class="line">          changes += <span class="string">"age "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row.street != street) &#123;</span><br><span class="line">          row.street = street;</span><br><span class="line">          changes += <span class="string">"street "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row.city != city) &#123;</span><br><span class="line">          row.city = city;</span><br><span class="line">          changes += <span class="string">"city "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row.state != state) &#123;</span><br><span class="line">          row.state = state;</span><br><span class="line">          changes += <span class="string">"state "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!changes.empty()) &#123;</span><br><span class="line">        send_summary(user, <span class="string">" successfully modified record in addressbook. Fields changed: "</span> + changes);</span><br><span class="line">        increment_counter(user, <span class="string">"modify"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        send_summary(user, <span class="string">" called upsert, but request resulted in no changes."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(name user)</span> </span>&#123;</span><br><span class="line">    require_auth(user);</span><br><span class="line">    <span class="function">address_index <span class="title">addresses</span><span class="params">(get_first_receiver(), get_first_receiver().value)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> iterator = addresses.find(user.value);</span><br><span class="line">    check(iterator != addresses.end(), <span class="string">"Record does not exist"</span>);</span><br><span class="line">    addresses.erase(iterator);</span><br><span class="line">    send_summary(user, <span class="string">" successfully erased record from addressbook"</span>);</span><br><span class="line">    increment_counter(user, <span class="string">"erase"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [[eosio::action]]</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">notify</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> msg)</span> </span>&#123;</span><br><span class="line">    require_auth(get_self());</span><br><span class="line">    require_recipient(user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> [[<span class="title">eosio</span>:</span>:table]] person &#123;</span><br><span class="line">    name key;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> first_name;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> last_name;</span><br><span class="line">    <span class="keyword">uint64_t</span> age;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> street;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> city;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> state;</span><br><span class="line">    <span class="keyword">uint64_t</span> primary_key() <span class="keyword">const</span> &#123; <span class="keyword">return</span> key.value; &#125;</span><br><span class="line">    <span class="keyword">uint64_t</span> get_secondary_1() <span class="keyword">const</span> &#123; <span class="keyword">return</span> age;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">send_summary</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> message)</span> </span>&#123;</span><br><span class="line">    action(</span><br><span class="line">      permission_level&#123;get_self(),<span class="string">"active"</span>_n&#125;,</span><br><span class="line">      get_self(),</span><br><span class="line">      <span class="string">"notify"</span>_n,</span><br><span class="line">      <span class="built_in">std</span>::make_tuple(user, name&#123;user&#125;.to_string() + message)</span><br><span class="line">    ).send();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">increment_counter</span><span class="params">(name user, <span class="built_in">std</span>::<span class="built_in">string</span> type)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    action counter = action(</span><br><span class="line">      permission_level&#123;get_self(),<span class="string">"active"</span>_n&#125;,</span><br><span class="line">      <span class="string">"abcounter"</span>_n,</span><br><span class="line">      <span class="string">"count"</span>_n,</span><br><span class="line">      <span class="built_in">std</span>::make_tuple(user, type)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    counter.send();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">typedef</span> eosio::multi_index&lt;<span class="string">"people"</span>_n, person, indexed_by&lt;<span class="string">"byage"</span>_n, const_mem_fun&lt;person, <span class="keyword">uint64_t</span>, &amp;person::get_secondary_1&gt;&gt;&gt; address_index;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="创建和使用自定义账户权限"><a href="#创建和使用自定义账户权限" class="headerlink" title="创建和使用自定义账户权限"></a>创建和使用自定义账户权限</h1><p>首先需要拥有一个父权限，才能自定义权限，从而控制合约的某些操作。</p>
<h2 id="创建自定义权限"><a href="#创建自定义权限" class="headerlink" title="创建自定义权限"></a>创建自定义权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos set account permission alice upsert EOS8STYz9TYuEDHS1fErjgaDR1ApTk62eEaBzC7Jhn486paNrgsZC owner -p alice@owner</span><br></pre></td></tr></table></figure>

<ol>
<li>创建名为upsert的新权限。</li>
<li>该upsert权限使用开发公钥作为许可。</li>
<li>它建立在alice账户上。</li>
</ol>
<h2 id="将合约action授权链接到自定义权限"><a href="#将合约action授权链接到自定义权限" class="headerlink" title="将合约action授权链接到自定义权限"></a>将合约action授权链接到自定义权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos set action permission alice addressbook upsert upsert</span><br></pre></td></tr></table></figure>

<p>授权upsert权限链接到addressbook合约的upsert操作。</p>
<h2 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h2><p>在alice的权限下调用upsert:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook upsert &#39;[&quot;alice&quot;, &quot;alice&quot;, &quot;liddel&quot;, 21, &quot;Herengracht&quot;, &quot;land&quot;, &quot;dam&quot;]&#39; -p alice@active</span><br></pre></td></tr></table></figure>

<p>会发现报错了。使用upsert权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action addressbook upsert &#39;[&quot;alice&quot;, &quot;alice&quot;, &quot;liddel&quot;, 21, &quot;Herengracht&quot;, &quot;land&quot;, &quot;dam&quot;]&#39; -p alice@upsert</span><br></pre></td></tr></table></figure>

<p>正常执行。</p>
<h1 id="支付action"><a href="#支付action" class="headerlink" title="支付action"></a>支付action</h1><p>在将token转移时触发的支付操作。</p>
<h2 id="创建HODL代币"><a href="#创建HODL代币" class="headerlink" title="创建HODL代币"></a>创建HODL代币</h2><p>创建一个hodl类，继承了eosio::contract</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;eosiolib&#x2F;eosio.hpp&gt;</span><br><span class="line">using namespace eosio;</span><br><span class="line"></span><br><span class="line">class [[eosio::contract(&quot;hodl&quot;)]] hodl:public eosio::contract&#123;</span><br><span class="line">	private:</span><br><span class="line">		static const uint32_t the_party &#x3D; 1645525342;	&#x2F;&#x2F;将hodl设置为在2022-2-22的晚10:22:22结束</span><br><span class="line">		const symbol hodl_symbol;	&#x2F;&#x2F;定义一个token符号，即SYS</span><br><span class="line">	public:</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后定义一个balance表来跟踪合约收到的token数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct [[eosio::table]] balance&#123;</span><br><span class="line">	eosio::asset funds;</span><br><span class="line">	uint64_t primary_key() const&#123;return funds.symbol.raw();&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了一个新的asset类型，表示数字token资产的类型。symbol资产实例的成员用作主键，通过调用raw()函数，将symbol变量转换为无符号整数。</p>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>将hodl_symbol初始化为SYS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public:</span><br><span class="line">	using contract::contract;</span><br><span class="line">	hodl(name receiver, name code, datastream&lt;const char*&gt;ds):contract(receiver, code, ds), hodl_symbol(&quot;SYS&quot;, 4)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个函数来访问当前UTC时间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uint32_t now()&#123;</span><br><span class="line">	return current_time_point().sec_since_epoch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写存款action"><a href="#编写存款action" class="headerlink" title="编写存款action"></a>编写存款action</h2><p>要接受转账，需要进行存款操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[[eosio::on_notify(&quot;eosio.token::transfer&quot;)]]</span><br><span class="line">void deposit(name hodler, name to, eosio::asset quantity, std::string memo)</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;检查不能转给自己</span><br><span class="line">  if (to !&#x3D; get_self() || hodler &#x3D;&#x3D; get_self())</span><br><span class="line">  &#123;</span><br><span class="line">    print(&quot;These are not the droids you are looking for.&quot;);</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F;检查提款时间未过去</span><br><span class="line">  check(now() &lt; the_party, &quot;You&#39;re way late&quot;);</span><br><span class="line">&#x2F;&#x2F;转账数量大于0</span><br><span class="line">  check(quantity.amount &gt; 0, &quot;When pigs fly&quot;);</span><br><span class="line">&#x2F;&#x2F;转账的token使用的是构造函数中指定的SYS</span><br><span class="line">  check(quantity.symbol &#x3D;&#x3D; hodl_symbol, &quot;These are not the droids you are looking for.&quot;);</span><br><span class="line">&#x2F;&#x2F;更新余额</span><br><span class="line">  balance_table balance(get_self(), hodler.value);</span><br><span class="line">  auto hodl_it &#x3D; balance.find(hodl_symbol.raw());</span><br><span class="line"></span><br><span class="line">  if (hodl_it !&#x3D; balance.end())</span><br><span class="line">    balance.modify(hodl_it, get_self(), [&amp;](auto &amp;row) &#123;</span><br><span class="line">      row.funds +&#x3D; quantity;</span><br><span class="line">    &#125;);</span><br><span class="line">  else</span><br><span class="line">    balance.emplace(get_self(), [&amp;](auto &amp;row) &#123;</span><br><span class="line">      row.funds &#x3D; quantity;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意开头的on_notify属性，它是EOSIO.CDT属性之一。用于对action进行注释。确保仅当通知来自于eosio.token合约的transfer操作时，传入的通知才转发到存款操作。eosio.token合约会在转移通知到达hodl的deposit操作之前检查发送者是否有足够的token。</p>
<h2 id="提款"><a href="#提款" class="headerlink" title="提款"></a>提款</h2><p>token存到hodl合约后，需要提款到账户。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[[eosio::action]]</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">party</span><span class="params">(name hodler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//Check the authority of hodler</span></span><br><span class="line">  require_auth(hodler);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Check the current time has passed the the_party time</span></span><br><span class="line">  check(now() &gt; the_party, <span class="string">"Hold your horses"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function">balance_table <span class="title">balance</span><span class="params">(get_self(), hodler.value)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span> hodl_it = balance.find(hodl_symbol.raw());</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Make sure the holder is in the table</span></span><br><span class="line">  check(hodl_it != balance.end(), <span class="string">"You're not allowed to party"</span>);</span><br><span class="line"></span><br><span class="line">  action&#123;</span><br><span class="line">    permission_level&#123;get_self(), <span class="string">"active"</span>_n&#125;,</span><br><span class="line">    <span class="string">"eosio.token"</span>_n,</span><br><span class="line">    <span class="string">"transfer"</span>_n,</span><br><span class="line">    <span class="built_in">std</span>::make_tuple(get_self(), hodler, hodl_it-&gt;funds, <span class="built_in">std</span>::<span class="built_in">string</span>(<span class="string">"Party! Your hodl is free."</span>))</span><br><span class="line">  &#125;.send();</span><br><span class="line"></span><br><span class="line">  balance.erase(hodl_it);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>检查提款账户是最初进行存款的账户。</li>
<li>找到锁定的余额。</li>
<li>将token从hodl转到账户。</li>
</ol>
<h2 id="完整合约"><a href="#完整合约" class="headerlink" title="完整合约"></a>完整合约</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/eosio.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/print.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/asset.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosio/system.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">"hodl"</span>)]] hodl : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> the_party = <span class="number">1645525342</span>;</span><br><span class="line">    <span class="keyword">const</span> symbol hodl_symbol;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> [[<span class="title">eosio</span>:</span>:table]] balance</span><br><span class="line">    &#123;</span><br><span class="line">      eosio::asset funds;</span><br><span class="line">      <span class="keyword">uint64_t</span> primary_key() <span class="keyword">const</span> &#123; <span class="keyword">return</span> funds.symbol.raw(); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> balance_table = eosio::multi_index&lt;<span class="string">"balance"</span>_n, balance&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> now() &#123;</span><br><span class="line">      <span class="keyword">return</span> current_time_point().sec_since_epoch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> contract::contract;</span><br><span class="line"></span><br><span class="line">    hodl(name receiver, name code, datastream&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt; ds) : contract(receiver, code, ds),hodl_symbol(<span class="string">"SYS"</span>, <span class="number">4</span>)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    [[eosio::on_notify(<span class="string">"eosio.token::transfer"</span>)]]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deposit</span><span class="params">(name hodler, name to, eosio::asset quantity, <span class="built_in">std</span>::<span class="built_in">string</span> memo)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (hodler == get_self() || to != get_self())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      check(now() &lt; the_party, <span class="string">"You're way late"</span>);</span><br><span class="line">      check(quantity.amount &gt; <span class="number">0</span>, <span class="string">"When pigs fly"</span>);</span><br><span class="line">      check(quantity.symbol == hodl_symbol, <span class="string">"These are not the droids you are looking for."</span>);</span><br><span class="line"></span><br><span class="line">      <span class="function">balance_table <span class="title">balance</span><span class="params">(get_self(), hodler.value)</span></span>;</span><br><span class="line">      <span class="keyword">auto</span> hodl_it = balance.find(hodl_symbol.raw());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hodl_it != balance.end())</span><br><span class="line">        balance.modify(hodl_it, get_self(), [&amp;](<span class="keyword">auto</span> &amp;row) &#123;</span><br><span class="line">          row.funds += quantity;</span><br><span class="line">        &#125;);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        balance.emplace(get_self(), [&amp;](<span class="keyword">auto</span> &amp;row) &#123;</span><br><span class="line">          row.funds = quantity;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [[eosio::action]]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">party</span><span class="params">(name hodler)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="comment">//Check the authority of hodlder</span></span><br><span class="line">      require_auth(hodler);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// //Check the current time has pass the the party time</span></span><br><span class="line">      check(now() &gt; the_party, <span class="string">"Hold your horses"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="function">balance_table <span class="title">balance</span><span class="params">(get_self(), hodler.value)</span></span>;</span><br><span class="line">      <span class="keyword">auto</span> hodl_it = balance.find(hodl_symbol.raw());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// //Make sure the holder is in the table</span></span><br><span class="line">      check(hodl_it != balance.end(), <span class="string">"You're not allowed to party"</span>);</span><br><span class="line"></span><br><span class="line">      action&#123;</span><br><span class="line">        permission_level&#123;get_self(), <span class="string">"active"</span>_n&#125;,</span><br><span class="line">        <span class="string">"eosio.token"</span>_n,</span><br><span class="line">        <span class="string">"transfer"</span>_n,</span><br><span class="line">        <span class="built_in">std</span>::make_tuple(get_self(), hodler, hodl_it-&gt;funds, <span class="built_in">std</span>::<span class="built_in">string</span>(<span class="string">"Party! Your hodl is free."</span>))</span><br><span class="line">      &#125;.send();</span><br><span class="line"></span><br><span class="line">      balance.erase(hodl_it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h2><p>创建一个账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos create account eosio hodl EOS8STYz9TYuEDHS1fErjgaDR1ApTk62eEaBzC7Jhn486paNrgsZC</span><br></pre></td></tr></table></figure>

<p>部署合约到该账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eosio-cpp hodl.cpp -o hodl.wasm</span><br><span class="line">cleos set contract hodl ./ -p hodl@active</span><br></pre></td></tr></table></figure>

<p>需要eosio.code权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos set account permission hodl active --add-code</span><br></pre></td></tr></table></figure>

<p>创建一个测试账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos create account eosio han EOS8STYz9TYuEDHS1fErjgaDR1ApTk62eEaBzC7Jhn486paNrgsZC</span><br></pre></td></tr></table></figure>

<p>将之前发布的SYStoken转移到han账户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action eosio.token transfer '[ "alice", "han", "100.0000 SYS", "Slecht geld verdrijft goed" ]' -p alice@active</span><br></pre></td></tr></table></figure>

<p>将一些token从han账户转移到hodl合约</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos transfer han hodl '0.0001 SYS' 'Hodl!' -p han@active</span><br></pre></td></tr></table></figure>

<p>为了测试提款功能，需要更新the_party变量，将它更新到过去的某个时间点。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONTRACT hodl : <span class="keyword">public</span> eosio::contract &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 9 June 2018 01:00:00</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> the_party = <span class="number">1528549200</span>;</span><br></pre></td></tr></table></figure>

<p>修改the_party值就行。测试提款：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cleos push action hodl party &#39;[&quot;han&quot;]&#39; -p han@active</span><br></pre></td></tr></table></figure>
    </div>
    
    <div class="reward" ontouchstart>
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            <span class="reward-type">
                <img class="alipay" src="/img/alipay.jpg"><b>支付宝打赏</b>
            </span>
            
            
            <span class="reward-type">
                <img class="wechat" src="/img/wechat.jpg"><b>微信打赏</b>
            </span>
            
        </div>
    </div>
    <p class="reward-tip">
        赞赏是不耍流氓的鼓励
    </p>
</div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="ggy.44pp.vip" target="_blank">ggy</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    
    <a href="/2021/03/17/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8%E4%B9%8BEOS%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/" class="next-post btn btn-default" title='区块链安全之EOS学习（二）'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            区块链安全之EOS学习（二）</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    
<div id="lv-container" data-id="city" data-uid="MTAyMC80ODM1Ni8yNDg1MA==">
    <script type="text/javascript">
    (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
    })(document, 'script');
    </script>
</div>

</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#二级索引"><span class="toc-text">二级索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#删除表中现有数据"><span class="toc-text">删除表中现有数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加新的索引成员及其获取器"><span class="toc-text">添加新的索引成员及其获取器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加辅助索引到addresses表配置"><span class="toc-text">添加辅助索引到addresses表配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改upsert程序"><span class="toc-text">修改upsert程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译-部署"><span class="toc-text">编译&#x2F;部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最终完整合约"><span class="toc-text">最终完整合约</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#添加内联操作"><span class="toc-text">添加内联操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#将eosio-code添加到权限"><span class="toc-text">将eosio.code添加到权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通知action"><span class="toc-text">通知action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#action构造器"><span class="toc-text">action构造器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调用"><span class="toc-text">调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最终完整合约-1"><span class="toc-text">最终完整合约</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译-部署-1"><span class="toc-text">编译&#x2F;部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试-1"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#对外部合约的内联操作"><span class="toc-text">对外部合约的内联操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建外部合约"><span class="toc-text">创建外部合约</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建合约账户"><span class="toc-text">创建合约账户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译-部署-2"><span class="toc-text">编译&#x2F;部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改addressbook合约"><span class="toc-text">修改addressbook合约</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最终合约"><span class="toc-text">最终合约</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重新编译-部署"><span class="toc-text">重新编译&#x2F;部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试-2"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#增加更多信息"><span class="toc-text">增加更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#创建和使用自定义账户权限"><span class="toc-text">创建和使用自定义账户权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建自定义权限"><span class="toc-text">创建自定义权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将合约action授权链接到自定义权限"><span class="toc-text">将合约action授权链接到自定义权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试-3"><span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#支付action"><span class="toc-text">支付action</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建HODL代币"><span class="toc-text">创建HODL代币</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造函数"><span class="toc-text">构造函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写存款action"><span class="toc-text">编写存款action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#提款"><span class="toc-text">提款</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完整合约"><span class="toc-text">完整合约</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试-4"><span class="toc-text">测试</span></a></li></ol></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2020
                    
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/assets/tagcanvas.min.js?rev=2.9.js"></script>

<script>
var tagOption = {
    textColour: '#444', // 字体颜色
    outlineMethod: 'block', // 选中模式
    outlineColour: '#FFDAB9', // 选中模式的颜色
    interval: 30 || 30, // 动画帧之间的时间间隔，值越大，转动幅度越大
    textHeight: 13,
    outlineRadius: 3,
    freezeActive: true || '', // 选中的标签是否继续滚动
    frontSelect: true || '', // 不选标签云后部的标签
    initial: [0.1, -0.1],
    depth: 0.5,
    decel: 0.95,
    maxSpeed: 0.03,
    reverse: true || '', // 是否反向触发
    fadeIn: 500, // 进入动画时间
    wheelZoom: false || '' // 是否启用鼠标滚轮
}
TagCanvas.Start('tag-cloud-3d', '', tagOption);
</script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash.js"></script>


<!-- 雪花特效 -->
<script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.js"></script>
<script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="\js\snow.js"></script>

<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/fireworks.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-haruto"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>